# Viral Content Agent Specification

## Overview
The Viral Content Agent is an autonomous worker designed to scan social signals, identify trending topics within a specific niche, and generate high-engagement content drafts (blogs, video scripts, social posts).

## Architecture
The agent operates on a scheduled interval (default: 1 hour) and executes the following pipeline:
1.  **Discovery:** Ingest trends from Google, YouTube, TikTok.
2.  **Filtering:** Score and dedup trends against the `discoveries` table.
3.  **Generation:** Transform high-scoring discoveries into content drafts.
4.  **Publishing:** (Optional) Auto-publish or queue for human review.

## Pipeline & Data Schema

### 1. Contents Table Schema
To support robust tracking and multi-channel distribution, the `contents` table serves as the source of truth for all generated artifacts.

| Field | Type | Description |
| :--- | :--- | :--- |
| `id` | UUID | Primary Key. |
| `trending_topic_id` | UUID | Foreign Key linking to the source trend discovery. |
| `content_type` | Enum | Type of artifact: `blog_post`, `short_video_script`, `tweet_thread`. |
| `title` | String | Optimized title for the specific platform. |
| `description` | Text | SEO description or caption text. |
| `tags` | Array<String> | Hashtags and metadata tags. |
| `blog_outline` | JSON | Structured H2/H3 outline (for blogs). |
| `blog_post` | Text (Markdown/HTML) | The full generated body content. |
| `social_captions` | JSON | Map of channel-specific captions (e.g., `{ twitter: "...", linkedin: "..." }`). |
| `status` | Enum | `draft`, `readyToPublish`, `published`, `failed`. |
| `version` | Integer | Iteration version (starts at 1). |
| `generation_attempt` | Integer | Track retries for this specific version. |
| `created_at` | Timestamp | Record creation time. |
| `updated_at` | Timestamp | Last update time. |
| `generated_at` | Timestamp | Timestamp when AI generation successfully completed. |
| `error_message` | Text | Detailed error log if status is `failed`. |
| `provider_meta` | JSON | Details on generation: `{ provider: "anthropic", model: "claude-3-5-sonnet", cost: 0.04 }`. |

### 2. Idempotency & Keying
To prevent duplicate generation costs and race conditions during high-volume processing:
*   **Unique Constraint:** A unique composite key must be enforced on `(trending_topic_id, content_type, version)`.
*   **Worker Logic:**
    1.  **Check:** Worker queries for an existing record matching the key.
    2.  **CreateIfNotExists:** If missing, insert a placeholder record with status `draft`.
    3.  **Resume/Retry:**
        *   If record exists and status is `failed`, check `generation_attempt`. If under limit, increment attempt and retry.
        *   If record exists and status is `draft`, `readyToPublish`, or `published`, the worker must skip execution (No-op).

### 3. AI Provider Abstraction
The system must remain resilient to provider outages and rate limits.
*   **Configuration:**
    *   **Primary:** High-intelligence model (e.g., Anthropic Claude 3.5 Sonnet) for initial reasoning and outlining.
    *   **Secondary:** Fallback model (e.g., OpenAI GPT-4o) for high availability.
*   **Retry & Backoff:**
    *   Implement exponential backoff for transient network errors (e.g., 2s, 4s, 8s).
*   **Fallback Behavior:**
    *   If the Primary provider returns a `429` (Quota Exceeded) or `5xx` (Server Error), the worker must **immediately** switch to the Secondary provider for the current attempt.
    *   This switch must be logged in `provider_meta` to track fallback usage costs.
    *   If both fail, update `status` to `failed` and record the `error_message`.

### 4. Versioning & Status Transitions
*   **Versioning Semantics:**
    *   `v1` is always the initial draft generated by the autonomous agent.
    *   `v2+` are reserved for manual user-triggered regenerations or "remixes" via the dashboard.
*   **Atomic Updates:** Status transitions (e.g., moving from `draft` to `readyToPublish`) must occur within a database transaction to ensure data integrity.

## Environment, Security, and Resilience

### Content Safety
To prevent the generation and distribution of harmful content, the agent implements a multi-layer moderation pipeline:
*   **Pre-flight Moderation:** All generated drafts pass through keyword blocklists and regex patterns to catch obvious violations immediately.
*   **Semantic ML Filters:** Content is analyzed using an automated moderation endpoint (e.g., OpenAI Moderation API or Google Safety classifiers) to detect hate speech, harassment, self-harm, and sexual content.
*   **Severity Scoring:** Each draft is assigned a safety score (0-1).
    *   **Safe (>0.8):** auto-approved for `draft` status.
    *   **Review Needed (0.5-0.8):** flagged for manual review; status set to `pending_review`.
    *   **Blocked (<0.5):** rejected immediately; status set to `failed` with violation category logged.
*   **Manual-Review Tiers:** High-risk topics (e.g., "finance", "health") automatically trigger a manual review requirement regardless of safety score.

### PII & Privacy Handling
*   **Data Minimization:** The agent processes public trends and generates synthetic content. It must *not* ingest or store User Generated Content (UGC) containing PII from social platforms.
*   **Allowed Data:** Public trend metadata (keywords, search volume), aggregated metrics.
*   **Forbidden Data:** Individual user tweets, comments with usernames, or direct messages.
*   **Pseudonymization:** If any user examples are needed for context, usernames must be replaced with generic placeholders (e.g., "User A") before storage.
*   **Retention Periods:**
    *   Generated Content: Indefinite (user asset).
    *   Raw Trend Data: 90 days.
    *   Logs: 30 days.
*   **GDPR/Consent:** Users must consent to AI processing of their inputs. The "Right to be Forgotten" applies to user-specific prompts and generated outputs, requiring a hard-delete capability.

### Rate Limiting & Throttling
To protect resources and manage costs, strict rate limits apply:
*   **Admin/Internal Endpoints:**
    *   `/api/admin/topics`: 100 requests/minute per user.
    *   `/api/agent/trigger`: 10 requests/minute (prevent spamming expensive generations).
*   **Public Endpoints:**
    *   `/api/public/*`: 10 requests/minute per IP.
*   **Burst Limits:** Allow short bursts of up to 2x the standard limit for < 10 seconds.
*   **Monitoring:** Alert DevOps if 429 errors exceed 5% of total traffic.

### API Key & Token Management
*   **Secure Storage:** API keys (OpenAI, Anthropic, Google) must be stored in a secure secret manager (e.g., AWS Secrets Manager, Vault) and injected as environment variables. Never committed to code.
*   **Rotation Cadence:** Keys should be rotated every 30-90 days.
*   **Automated Rotation:** Scripts should exist to update keys in the secret manager without downtime.
*   **Audit Logging:** Every use of an API key is logged with timestamp, operation, and cost estimation to detect anomalies.
*   **Incident Procedures:** If a key leak is suspected, the key is immediately revoked at the provider level and a new key is issued.